<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PurchaseOfferMarket | SubQuery Network API</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/network-contracts/assets/css/0.styles.aa64b011.css" as="style"><link rel="preload" href="/network-contracts/assets/js/app.87a047ab.js" as="script"><link rel="preload" href="/network-contracts/assets/js/2.27a40bc7.js" as="script"><link rel="preload" href="/network-contracts/assets/js/21.92efbd71.js" as="script"><link rel="prefetch" href="/network-contracts/assets/js/10.dc2fb91c.js"><link rel="prefetch" href="/network-contracts/assets/js/11.089f3f28.js"><link rel="prefetch" href="/network-contracts/assets/js/12.1a2cee0f.js"><link rel="prefetch" href="/network-contracts/assets/js/13.65bbe297.js"><link rel="prefetch" href="/network-contracts/assets/js/14.ffe4e780.js"><link rel="prefetch" href="/network-contracts/assets/js/15.565d45f4.js"><link rel="prefetch" href="/network-contracts/assets/js/16.502a2abc.js"><link rel="prefetch" href="/network-contracts/assets/js/17.daa31d2a.js"><link rel="prefetch" href="/network-contracts/assets/js/18.2c831974.js"><link rel="prefetch" href="/network-contracts/assets/js/19.88a66e6d.js"><link rel="prefetch" href="/network-contracts/assets/js/20.19d92089.js"><link rel="prefetch" href="/network-contracts/assets/js/22.80800923.js"><link rel="prefetch" href="/network-contracts/assets/js/23.2ebcae78.js"><link rel="prefetch" href="/network-contracts/assets/js/24.80249bc3.js"><link rel="prefetch" href="/network-contracts/assets/js/25.3b934353.js"><link rel="prefetch" href="/network-contracts/assets/js/26.cfb06d9f.js"><link rel="prefetch" href="/network-contracts/assets/js/27.d0ed7b47.js"><link rel="prefetch" href="/network-contracts/assets/js/28.b37cf957.js"><link rel="prefetch" href="/network-contracts/assets/js/29.909e4505.js"><link rel="prefetch" href="/network-contracts/assets/js/3.dc631073.js"><link rel="prefetch" href="/network-contracts/assets/js/30.af6d54f3.js"><link rel="prefetch" href="/network-contracts/assets/js/31.75511620.js"><link rel="prefetch" href="/network-contracts/assets/js/32.1790e3e4.js"><link rel="prefetch" href="/network-contracts/assets/js/33.7d895206.js"><link rel="prefetch" href="/network-contracts/assets/js/34.98332cb4.js"><link rel="prefetch" href="/network-contracts/assets/js/35.092db0d4.js"><link rel="prefetch" href="/network-contracts/assets/js/36.16c2737f.js"><link rel="prefetch" href="/network-contracts/assets/js/37.eb7412c9.js"><link rel="prefetch" href="/network-contracts/assets/js/38.254dafb8.js"><link rel="prefetch" href="/network-contracts/assets/js/39.6803e9a0.js"><link rel="prefetch" href="/network-contracts/assets/js/4.344717be.js"><link rel="prefetch" href="/network-contracts/assets/js/40.1c61e7d4.js"><link rel="prefetch" href="/network-contracts/assets/js/41.21676a98.js"><link rel="prefetch" href="/network-contracts/assets/js/42.280c4e20.js"><link rel="prefetch" href="/network-contracts/assets/js/43.118aface.js"><link rel="prefetch" href="/network-contracts/assets/js/44.de03f1d9.js"><link rel="prefetch" href="/network-contracts/assets/js/45.7ca3dbb3.js"><link rel="prefetch" href="/network-contracts/assets/js/46.cafa4c3e.js"><link rel="prefetch" href="/network-contracts/assets/js/47.f3cebf03.js"><link rel="prefetch" href="/network-contracts/assets/js/48.6b3b9785.js"><link rel="prefetch" href="/network-contracts/assets/js/49.77625728.js"><link rel="prefetch" href="/network-contracts/assets/js/5.be4723dc.js"><link rel="prefetch" href="/network-contracts/assets/js/50.97cb6565.js"><link rel="prefetch" href="/network-contracts/assets/js/51.8c4ea14d.js"><link rel="prefetch" href="/network-contracts/assets/js/6.c89030cc.js"><link rel="prefetch" href="/network-contracts/assets/js/7.4680987c.js"><link rel="prefetch" href="/network-contracts/assets/js/8.0940ac83.js"><link rel="prefetch" href="/network-contracts/assets/js/9.8f7e1582.js">
    <link rel="stylesheet" href="/network-contracts/assets/css/0.styles.aa64b011.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/network-contracts/" class="home-link router-link-active"><!----> <span class="site-name">SubQuery Network API</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="purchaseoffermarket"><a href="#purchaseoffermarket" class="header-anchor">#</a> PurchaseOfferMarket</h2> <h3 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h3> <p>The Purchase Offer Market Contract tracks all purchase offers for Indexers and Consumers.
It allows Consumers to create/cancel purchase offers, and Indexers to accept the purchase offer to make
the service agreements. It is the place Consumer publish a purchase offer for a specific deployment.
And also the place indexers can search and take these purchase offers.</p> <h3 id="terminology"><a href="#terminology" class="header-anchor">#</a> Terminology</h3> <p>Purchase Offer: A Purchase Offer is created by the Consumer, any Indexer can accept it to make the
service agreement.</p> <h3 id="detail"><a href="#detail" class="header-anchor">#</a> Detail</h3> <p>We design the date structure for Purchase Offer, It stores purchase offer related information.
A Purchase Offer can accepted by multiple Indexers. Consumer transfer Token to this contract as long as
the purchase offer is created. And when Indexer accept the offer, the corresponding part of the money will
transfer to serviceAgrementRegistry contract first and wait rewardDistributer contract take and distribute.
After Indexer accept the offer we use the planTemplate that stored in Purchase Offer structure to generate
the service agreement.</p> <p>Consumers can cancel their purchase offer after expire date for free, but if cancel the unexpired Purchase Offer
we will charge the penalty fee.</p> <h3 id="purchaseoffer"><a href="#purchaseoffer" class="header-anchor">#</a> PurchaseOffer</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">struct</span> <span class="token class-name">PurchaseOffer</span> <span class="token punctuation">{</span>
  <span class="token builtin">uint256</span> deposit<span class="token punctuation">;</span>
  <span class="token builtin">uint256</span> minimumAcceptHeight<span class="token punctuation">;</span>
  <span class="token builtin">uint256</span> minimumStakingAmount<span class="token punctuation">;</span>
  <span class="token builtin">uint256</span> planTemplateId<span class="token punctuation">;</span>
  <span class="token builtin">bytes32</span> deploymentId<span class="token punctuation">;</span>
  <span class="token builtin">uint256</span> expireDate<span class="token punctuation">;</span>
  <span class="token builtin">address</span> consumer<span class="token punctuation">;</span>
  <span class="token builtin">bool</span> active<span class="token punctuation">;</span>
  <span class="token builtin">uint16</span> limit<span class="token punctuation">;</span>
  <span class="token builtin">uint16</span> numAcceptedContracts<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="states"><a href="#states" class="header-anchor">#</a> STATES</h3> <h3 id="settings"><a href="#settings" class="header-anchor">#</a> settings</h3> <p>ISettings contract which stores SubQuery network contracts address</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">contract</span> <span class="token class-name">ISettings</span> settings
</code></pre></div><h3 id="offers"><a href="#offers" class="header-anchor">#</a> offers</h3> <p>offerId =&gt; Offer</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> <span class="token keyword">struct</span> <span class="token class-name">PurchaseOfferMarket</span><span class="token punctuation">.</span>PurchaseOffer<span class="token punctuation">)</span> offers
</code></pre></div><h3 id="numoffers"><a href="#numoffers" class="header-anchor">#</a> numOffers</h3> <p>number of all offers</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token builtin">uint256</span> numOffers
</code></pre></div><h3 id="penaltyrate"><a href="#penaltyrate" class="header-anchor">#</a> penaltyRate</h3> <p>penalty rate of consumer cancel the unexpired offer</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token builtin">uint256</span> penaltyRate
</code></pre></div><h3 id="penaltydestination"><a href="#penaltydestination" class="header-anchor">#</a> penaltyDestination</h3> <p>if penalty destination address is 0x00, then burn the penalty</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token builtin">address</span> penaltyDestination
</code></pre></div><h3 id="offerpoi"><a href="#offerpoi" class="header-anchor">#</a> offerPoi</h3> <p>offerId =&gt; Indexer =&gt; _poi</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> <span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> offerPoi
</code></pre></div><h3 id="events"><a href="#events" class="header-anchor">#</a> EVENTS</h3> <h3 id="purchaseoffercreated"><a href="#purchaseoffercreated" class="header-anchor">#</a> PurchaseOfferCreated</h3> <p>Emitted when Consumer create a purchase offer</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">event</span> <span class="token function">PurchaseOfferCreated</span><span class="token punctuation">(</span><span class="token builtin">address</span> consumer<span class="token punctuation">,</span> <span class="token builtin">uint256</span> offerId<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> deploymentId<span class="token punctuation">,</span> <span class="token builtin">uint256</span> planTemplateId<span class="token punctuation">,</span> <span class="token builtin">uint256</span> deposit<span class="token punctuation">,</span> <span class="token builtin">uint16</span> limit<span class="token punctuation">,</span> <span class="token builtin">uint256</span> minimumAcceptHeight<span class="token punctuation">,</span> <span class="token builtin">uint256</span> minimumStakingAmount<span class="token punctuation">,</span> <span class="token builtin">uint256</span> expireDate<span class="token punctuation">)</span>
</code></pre></div><h3 id="purchaseoffercancelled"><a href="#purchaseoffercancelled" class="header-anchor">#</a> PurchaseOfferCancelled</h3> <p>Emitted when Consumer cancel a purchase offer</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">event</span> <span class="token function">PurchaseOfferCancelled</span><span class="token punctuation">(</span><span class="token builtin">address</span> creator<span class="token punctuation">,</span> <span class="token builtin">uint256</span> offerId<span class="token punctuation">,</span> <span class="token builtin">uint256</span> penalty<span class="token punctuation">)</span>
</code></pre></div><h3 id="offeraccepted"><a href="#offeraccepted" class="header-anchor">#</a> OfferAccepted</h3> <p>Emitted when Indexer accept an offer</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">event</span> <span class="token function">OfferAccepted</span><span class="token punctuation">(</span><span class="token builtin">address</span> indexer<span class="token punctuation">,</span> <span class="token builtin">uint256</span> offerId<span class="token punctuation">,</span> <span class="token builtin">uint256</span> agreementId<span class="token punctuation">)</span>
</code></pre></div><p>MODIFIER</p> <h3 id="onlyindexer"><a href="#onlyindexer" class="header-anchor">#</a> onlyIndexer</h3> <p>require caller is indexer</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">modifier</span> <span class="token function">onlyIndexer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="initialize"><a href="#initialize" class="header-anchor">#</a> initialize</h3> <p>Initialize this contract to set penaltyRate and penaltyDestination.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">contract</span> <span class="token class-name">ISettings</span> _settings<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _penaltyRate<span class="token punctuation">,</span> <span class="token builtin">address</span> _penaltyDestination<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td>_settings</td> <td>contract ISettings</td> <td>ISettings contract</td></tr> <tr><td>_penaltyRate</td> <td>uint256</td> <td>penaltyRate that consumer cancel unexpired purchase offer</td></tr> <tr><td>_penaltyDestination</td> <td>address</td> <td>penaltyDestination that consumer cancel unexpired purchase offer</td></tr></tbody></table> <h3 id="setsettings"><a href="#setsettings" class="header-anchor">#</a> setSettings</h3> <p>Update setting state.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">setSettings</span><span class="token punctuation">(</span><span class="token keyword">contract</span> <span class="token class-name">ISettings</span> _settings<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td>_settings</td> <td>contract ISettings</td> <td>ISettings contract</td></tr></tbody></table> <h3 id="setpenaltyrate"><a href="#setpenaltyrate" class="header-anchor">#</a> setPenaltyRate</h3> <p>allow admin the set the Penalty Rate for cancel unexpired offer.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">setPenaltyRate</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _penaltyRate<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td>_penaltyRate</td> <td>uint256</td> <td>penalty rate to set</td></tr></tbody></table> <h3 id="setpenaltydestination"><a href="#setpenaltydestination" class="header-anchor">#</a> setPenaltyDestination</h3> <p>allow admin to set the Penalty Destination address. All Penalty will transfer to this address, if penalty destination address is 0x00, then burn the penalty.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">setPenaltyDestination</span><span class="token punctuation">(</span><span class="token builtin">address</span> _penaltyDestination<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td>_penaltyDestination</td> <td>address</td> <td>penalty destination to set</td></tr></tbody></table> <h3 id="createpurchaseoffer"><a href="#createpurchaseoffer" class="header-anchor">#</a> createPurchaseOffer</h3> <p>Allow admin to create a Purchase Offer.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">createPurchaseOffer</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _deploymentId<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _planTemplateId<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _deposit<span class="token punctuation">,</span> <span class="token builtin">uint16</span> _limit<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _minimumAcceptHeight<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _minimumStakingAmount<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _expireDate<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td>_deploymentId</td> <td>bytes32</td> <td>deployment id</td></tr> <tr><td>_planTemplateId</td> <td>uint256</td> <td>plan template id</td></tr> <tr><td>_deposit</td> <td>uint256</td> <td>purchase offer value to deposit</td></tr> <tr><td>_limit</td> <td>uint16</td> <td>limit indexer to accept the purchase offer</td></tr> <tr><td>_minimumAcceptHeight</td> <td>uint256</td> <td>minimum block height to accept the purchase offer</td></tr> <tr><td>_minimumStakingAmount</td> <td>uint256</td> <td>minimum staking amount to accept the purchase offer</td></tr> <tr><td>_expireDate</td> <td>uint256</td> <td>expire date of the purchase offer in unix timestamp</td></tr></tbody></table> <h3 id="cancelpurchaseoffer"><a href="#cancelpurchaseoffer" class="header-anchor">#</a> cancelPurchaseOffer</h3> <p>Allow Consumer to cancel their Purchase Offer. Consumer transfer all tokens to this contract when they create the offer. We will charge a Penalty to cancel unexpired Offer. And the Penalty will transfer to a configured address. If the address not configured, then we burn the Penalty.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">cancelPurchaseOffer</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _offerId<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td>_offerId</td> <td>uint256</td> <td>purchase offer id to cancel</td></tr></tbody></table> <h3 id="acceptpurchaseoffer"><a href="#acceptpurchaseoffer" class="header-anchor">#</a> acceptPurchaseOffer</h3> <p>Allow Indexer to accept the offer and make the service agreement.
The corresponding part of the money will transfer to serviceAgrementRegistry contract
and wait rewardDistributer contract take and distribute as long as Indexer accept the offer.
When Indexer accept the offer we need to ensure Indexer's deployment reaches the minimumAcceptHeight,
So we ask indexers to pass the latest poi value when accepting the purchase offer,
and save this poi value when agreement create.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">acceptPurchaseOffer</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _offerId<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> _poi<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td>_offerId</td> <td>uint256</td> <td>purchase offer id to accept</td></tr> <tr><td>_poi</td> <td>bytes32</td> <td>proof of index (hash) to accept the purchase offer</td></tr></tbody></table> <h3 id="isexpired"><a href="#isexpired" class="header-anchor">#</a> isExpired</h3> <p>Return the purchase offer is expired</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _offerId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre></div><table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td>_offerId</td> <td>uint256</td> <td>purchase offer id</td></tr></tbody></table> <p>Return:  bool -&gt; bool the result of is the purchase offer expired</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/network-contracts/assets/js/app.87a047ab.js" defer></script><script src="/network-contracts/assets/js/2.27a40bc7.js" defer></script><script src="/network-contracts/assets/js/21.92efbd71.js" defer></script>
  </body>
</html>
